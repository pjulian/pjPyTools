name: Deploy

on:
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'
        type: choice
        options:
        - info
        - warning
        - debug
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

jobs:
  deploy:
    runs-on: pjpytools
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_PJPYTOOLS }}

      - name: Store the latest_tag in steps.vars.outputs
        id: vars
        run: |
          git fetch --tags
          LATEST_TAG=$(git tag | sort --version-sort | tail -n1)
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Check release version output
        env:
          RELEASE_VERSION: ${{ steps.vars.outputs.latest_tag }}
        run: |
          echo $RELEASE_VERSION

      -name: Set environment abbreviation
        id: setenv
        run: |
          ENV_ABBR=$(build_env='stg'; if [[ ${{ inputs.environment}} == "production" ]]; then build_env='prd'; fi; echo $build_env)
          echo "build_env=$ENV_ABBR" >> $GITHUB_OUTPUT

      - name: Check environment abbreviation output
        env:
          BUILD_ENV: ${{ steps.setenv.outputs.build_env }}
        run: |
          echo $BUILD_ENV

      - name: Prepare Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY_PJULIAN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          buildenv: ${{ inputs.environment }}
          ssh: |
            default=${{ env.SSH_AUTH_SOCK }}
          # The build context (current directory of the repository).
          context: .
          # Path to the Dockerfile.
          file: ./Dockerfile
          # Set to true to push to a registry (e.g., Docker Hub, GHCR).
          push: false
          # Set to true to load the built image into the local Docker daemon.
          load: true
          # Define image tags (e.g., your-username/my-image:latest)
          tags: |
            pjpytools-${{ steps.setenv.outputs.build_env }}:latest
            pjpytools-${{ steps.setenv.outputs.build_env }}:${{ steps.vars.outputs.latest_tag }}
          # Add other options like build-args, target, etc. as needed

      - name: Get docker images list
        id: dockervars
        run: |
          COMMAND_RESULT=$(docker image ls | grep pjpytools-)
          # echo "docker_image_list=$COMMAND_RESULT" >> $GITHUB_OUTPUT
          echo "docker_image_list<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMAND_RESULT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Display results of getting the docker images list
        run: |
          echo "${{ steps.dockervars.outputs.docker_image_list }}"
